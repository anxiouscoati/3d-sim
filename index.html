<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trainer 3D Viewer</title>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    :root { --radius: 18px; }

    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: #fff; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }

    .viewer {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      background: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }

    model-viewer {
      width: 100%;
      height: 560px;
      display: block;
      background: #fff;
      touch-action: none; /* важно для iOS Safari */
    }

    /* Hint overlay */
    .hint {
      position: absolute;
      left: 16px;
      bottom: 16px;
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(0,0,0,.10);
      user-select: none;
      pointer-events: none; /* не мешает вращать */
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .25s ease, transform .25s ease;
    }
    .hint.show { opacity: 1; transform: translateY(0); }

    .hintText { font-size: 13px; line-height: 1.1; opacity: .8; }
    .hintText strong { opacity: 1; }

    .finger {
      width: 34px; height: 34px;
      border-radius: 999px;
      display: grid; place-items: center;
      background: rgba(0,0,0,.04);
    }
    .finger svg { width: 18px; height: 18px; opacity: .75; }

    .swipe {
      position: relative;
      width: 46px;
      height: 10px;
      margin-left: 2px;
      opacity: .55;
    }
    .swipe::before,
    .swipe::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      transform: translateY(-50%);
      animation: swipe 1.4s ease-in-out infinite;
    }
    .swipe::after { animation-delay: .18s; opacity: .55; }
    @keyframes swipe {
      0%   { left: 2px;  opacity: .2; }
      35%  { left: 34px; opacity: .6; }
      70%  { left: 2px;  opacity: .2; }
      100% { left: 2px;  opacity: .2; }
    }

    @media (max-width: 600px) {
      model-viewer { height: 420px; }
      .hint { left: 12px; bottom: 12px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="viewer">
      <model-viewer
        id="mv"
        src="./PresidentLux_Test2.glb"

        camera-controls
        disable-zoom
        disable-pan
        interaction-prompt="none"
        loading="eager"
        reveal="auto"

        /* стартовые значения (потом JS подстроит точно) */
        camera-orbit="0deg 90deg 8m"
        min-camera-orbit="-80deg 90deg 8m"
        max-camera-orbit="80deg 90deg 8m"

        camera-target="auto auto auto"
        field-of-view="30deg"
        exposure="1"
      ></model-viewer>

      <div id="hint" class="hint">
        <div class="finger" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M10 12V6a2 2 0 1 1 4 0v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M14 12V8a2 2 0 1 1 4 0v7.5a4.5 4.5 0 0 1-9 0V13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 13l-1.2-1.2a2 2 0 1 0-2.8 2.8L10 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="hintText">
          <strong>Проведите</strong> пальцем / мышью<br/>чтобы повернуть
        </div>
        <div class="swipe" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <script>
    const mv = document.getElementById('mv');
    const hint = document.getElementById('hint');

    const showHint = () => hint.classList.add('show');
    const hideHint = () => hint.classList.remove('show');

    showHint();
    const autoHide = setTimeout(hideHint, 6000);

    const hideOnInteract = () => {
      clearTimeout(autoHide);
      hideHint();
      mv.removeEventListener('pointerdown', hideOnInteract);
      mv.removeEventListener('touchstart', hideOnInteract);
    };
    mv.addEventListener('pointerdown', hideOnInteract);
    mv.addEventListener('touchstart', hideOnInteract, { passive: true });

    // ---- Авто-кадрирование: отодвигаем камеру так, чтобы модель влезла ----
    mv.addEventListener('load', () => {
      // Центр модели
      const c = mv.getBoundingBoxCenter(); // {x,y,z}
      // Размеры модели
      const s = mv.getDimensions();        // {x,y,z}

      // Target = центр модели (и чуть выше, чтобы платформа не "лежала" внизу)
      const targetY = c.y + (s.y * 0.10);
      mv.cameraTarget = `${c.x}m ${targetY}m ${c.z}m`;

      // Рассчитываем дистанцию, чтобы влезло по ширине/глубине
      const fovDeg = 30;
      const fov = fovDeg * Math.PI / 180;

      // aspect берём из реального размера canvas
      const rect = mv.getBoundingClientRect();
      const aspect = Math.max(0.2, rect.width / Math.max(1, rect.height));

      // горизонтальный FOV
      const hFov = 2 * Math.atan(Math.tan(fov / 2) * aspect);

      // хотим вместить самый "длинный" размер в кадр:
      const maxH = Math.max(s.x, s.z); // длина/ширина тренажёра
      const padding = 1.25;           // запас по краям (увеличьте до 1.35 если нужно)
      const dist = (maxH * padding) / (2 * Math.tan(hFov / 2));

      // Фиксируем только горизонтальное вращение на ~160° (зад не показываем)
      const az = 0;               // стартовый азимут
      const polar = 90;           // фикс вертикали
      const limit = 80;           // +/- 80° = 160° (если хотите ближе к 180 — поставьте 85/90)

      mv.cameraOrbit = `${az}deg ${polar}deg ${dist}m`;
      mv.minCameraOrbit = `${-limit}deg ${polar}deg ${dist}m`;
      mv.maxCameraOrbit = `${limit}deg ${polar}deg ${dist}m`;

      // Подсказку ещё раз покажем на пару секунд после загрузки
      showHint();
      setTimeout(hideHint, 4500);
    });
  </script>
</body>
</html>
